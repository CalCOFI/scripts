---
title: "Oceanographic Bottle Database"
author: "Ben Best"
date: "1/24/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read Oceano Bottle data

```{r}
# packages
if (!require("librarian")){
  install.packages("librarian")
  library(librarian)
}
librarian::shelf(
  dplyr, glue, gstat, here, mapview, readr, 
  rmapshaper, sf, skimr, stars, stringr)

# paths
dir_data <- switch(
  Sys.info()["nodename"],
  `ben-mbpro` = "/Users/bbest/My Drive (ben@ecoquants.com)/projects/calcofi/data",
  `Cristinas-MacBook-Pro.local` = "/Volumes/GoogleDrive/.shortcut-targets-by-id/13pWB5x59WSBR0mr9jJjkx7rri9hlUsMv/calcofi/data")
  # TODO: get Erin's Google Drive path and "nodename")
bottle_csv <- file.path(dir_data, "/oceanographic-data/bottle-database/CalCOFI_Database_194903-202001_csv_22Sep2021/194903-202001_Bottle.csv")
cast_csv <- file.path(dir_data, "/oceanographic-data/bottle-database/CalCOFI_Database_194903-202001_csv_22Sep2021/194903-202001_Cast.csv")
calcofi_geo <- here("data/calcofi_oceano-bottle-stations_convex-hull.geojson")

# check paths
stopifnot(dir.exists(dir_data))
stopifnot(any(file.exists(bottle_csv,cast_csv)))

# read data
d_bottle <- read_csv(bottle_csv, skip=1, col_names = F)
names(d_bottle) <- str_split(
  readLines(bottle_csv, n=1), ",")[[1]] %>% 
  str_replace("\xb5", "Âµ")
d_cast   <- read_csv(cast_csv)

# join data
d <- d_cast %>% 
  left_join(
    d_bottle %>% select(-Sta_ID),
    by = "Cst_Cnt") %>% 
  mutate(Date = lubridate::as_date(Date, format = "%m/%d/%Y"))
```

## Exploratory summary of bottle data

```{r}
# d_cast
skim(d_cast)
```

```{r}
# d_bottle
skim(d_bottle)
```

## Get CINMS AOI

```{r}
# get example AOI (Channel Islands NMS)
sanctuaries_geo <- "https://github.com/noaa-onms/onmsR/raw/12a87dfd4b90f2e3009ccb4913315fb2df7afddc/data-raw/sanctuaries.geojson"

cinms_ply <- sf::st_read(sanctuaries_geo) %>%
  dplyr::filter(nms == "CINMS")

# get AOI geom points as WKT for later use with API
cinms_txt <- sf::st_as_text(cinms_ply$geometry)
#cinms_txt

mapview(cinms_ply)
```

## Generate summary stats by station ID (as points)

```{r}
# for summary, want to group by Sta_Code because each data point has a diff Sta_ID
pts <- d %>% 
  filter(
    !is.na(Lat_Dec),
    !is.na(Lon_Dec)) %>% 
  group_by(
    Sta_ID) %>%
  summarize(
    lon      = mean(Lon_Dec),
    lat      = mean(Lat_Dec)) %>%
  st_as_sf(
    coords = c("lon", "lat"), crs=4326, remove = F)
mapview(pts)

# Make CalCOFI Study Area
hull <- st_convex_hull(st_union(pts)) %>% 
  st_buffer(0.1) %>%  # ~10 km
  ms_simplify(keep = 0.05) 
mapview(pts) +
  mapview(hull)

# write to geojson
st_write(hull, calcofi_geo)

# summarize temp data by station code 
summ_pnts_station <- pnts_station %>% 
  group_by(sta_code) %>%
  na.omit() %>% 
  summarize(
    aoi          = aoi,
    date_start   = min(date),
    date_end     = max(date),
    # date_step    = ,
    depth_m_min  = min(depth_m),
    depth_m_max  = max(depth_m),
    temp_c_mean  = mean(temp_c),
    temp_c_min   = min(temp_c),
    temp_c_max   = max(temp_c),
    temp_c_stdev = sd(temp_c),
    temp_c_hi90  = quantile(temp_c, .9),
    temp_c_lo10  = quantile(temp_c, .1)) 
    
# intersect with AOI




    
  





# station_data_T <- d %>% group_by(Sta_Code) %>%
#   select(Date, Depthm, T_degC) %>% drop_na() %>% 
#   summarize(
#     date_start   = min(Date),
#     date_end     = max(Date),
#     depth_m_min  = min(Depthm),
#     depth_m_max  = max(Depthm),
#     T_degC_mean  = mean(T_degC),
#     T_degC_min   = min(T_degC),
#     T_degC_max   = max(T_degC),
#     T_degC_stdev = sd(T_degC),
#     T_degC_hi90  = quantile(T_degC, .9),
#     T_degC_lo10  = quantile(T_degC, .1)
#   )
```

## Interpolate (idw/kriging) for maps

### Map by station ID

```{r}
# group by station ID
d_station <- d %>% group_by(Sta_ID) %>% 
  summarize(lat = Lat_Dec, lon = Lon_Dec, depth_m = Depthm, sta_code = Sta_Code)
```

### [Example](https://geobgu.xyz/r-2020/spatial-interpolation-of-point-data.html)

```{r}
d_aoi <- st_as_sf(d_station, coords = c("lat", "lon"), crs = 32636)
```

# get [DEM raster](https://earthexplorer.usgs.gov/)

```{r}
# get raster data (from `cinms_dem`)
dem1 <- read_stars(cinms_dem1)
dem2 <- read_stars(cinms_dem2) 
dem  <- st_mosaic(dem1, dem2) 
names(dem) <- "depth_m_dem"

# depth <- st_join(d_aoi, st_as_sf(dem)) # `Error: vector memory exhausted (limit reached?)`
# depth <- depth[!is.na(dem$depth), ]

# TEST: IDW interpolation
# define model
mod <- gstat(data = d_aoi, formula = depth_m ~ 1)

# interpolate 
z <- predict(mod, dem)

```


## Summarize by AOI

### Extract points by AOI

```{r}

```

### Summary stats on station data as points 

# TODO: summarize OCEAN TEMP, OXYGEN (HYPOXIA), ZOOPLANKTON, ICHTHYOPLANKTON for each station ID

```{r}
# filter data corresponding to AOI 
station_data <- d %>% group_by(Sta_ID) %>%
  select(Sta_Code, Date, Depthm, T_degC) %>% drop_na() %>% 
  summarize(
    date_start = min(Date),
    date_end = max(Date),
    depth_min = min(Depthm),
    depth_max = max(Depthm),
    T_mean = mean(T_degC),
    T_min = min(T_degC),
    T_max = max(T_degC),
    T_stdev = sd(T_degC),
    T_hi90 = quantile(T_degC, .9),
    T_lo10 = quantile(T_degC, .1)
  )

# flat temp data by station code
station_data_T <- d %>% group_by(Sta_Code) %>%
  mutate(Date = lubridate::as_date(Date, format = "%m/%d/%Y")) %>% 
  select(Date, Depthm, T_degC) %>% drop_na() %>% 
  summarize(
    date_start   = min(Date),
    date_end     = max(Date),
    depth_m_min  = min(Depthm),
    depth_m_max  = max(Depthm),
    T_degC_mean  = mean(T_degC),
    T_degC_min   = min(T_degC),
    T_degC_max   = max(T_degC),
    T_degC_stdev = sd(T_degC),
    T_degC_hi90  = quantile(T_degC, .9),
    T_degC_lo10  = quantile(T_degC, .1)
  )

# flat salinity data by station code
station_data_sal <- d %>% group_by(Sta_Code) %>%
  mutate(Date = lubridate::as_date(Date, format = "%m/%d/%Y")) %>% 
  select(Date, Depthm, Salnty) %>% drop_na() %>% 
  summarize(
    date_start   = min(Date),
    date_end     = max(Date),
    depth_m_min  = min(Depthm),
    depth_m_max  = max(Depthm),
    Salnty_mean  = mean(Salnty),
    Salnty_min   = min(Salnty),
    Salnty_max   = max(Salnty),
    Salnty_stdev = sd(Salnty),
    Salnty_hi90  = quantile(Salnty, .9),
    Salnty_lo10  = quantile(Salnty, .1)
  )

```



## Interpolate points to surface with `idw()` or `krige()`

## Extract from surface

## Create `read_bottle()` in `calcofi4r`

## Visualize initial variables
